name: CI

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

jobs:
  build_and_publish_to_firebase:
    name: Publish app for internal testing
    runs-on: macOS-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-java@v1
      with:
        java-version: '12.x'
    - uses: subosito/flutter-action@v1
      with:
        channel: 'stable'
    - run: npm install -g firebase-tools
    - run: flutter pub get
    - run: flutter build apk --flavor dev
    - working-directory: ./android
      run: fastlane run firebase_app_distribution app:1:19662603391:android:d82f1b46633823fabd2b4a apk_path:"../build/app/outputs/apk/dev/release/app-dev-release.apk" groups:"testers" firebase_cli_token:${{secrets.FIREBASE_TOKEN}}
    - run: flutter build ios --flavor dev --no-codesign
    - name: Prepare code signing
      working-directory: ./ios
      env:
        KEYCHAIN_NAME: pinger-keychain
        KEYCHAIN_PASSWORD: ${{secrets.KEYCHAIN_PASSWORD}}
        MATCH_PASSWORD: ${{secrets.MATCH_PASSWORD}}
        GIT_BASIC_AUTHORIZATION: ${{secrets.GIT_BASIC_AUTHORIZATION}}
      run: fastlane setup_code_signing
    - name: Build and publish iOS
      working-directory: ./ios
      env:
        FIREBASE_TOKEN: ${{secrets.FIREBASE_TOKEN}}
      run: fastlane build_and_publish
